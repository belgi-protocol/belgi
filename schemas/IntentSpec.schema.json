{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "IntentSpec.schema.json",
  "title": "IntentSpec (Core Intent Contract v1)",
  "description": "Schema for the machine-parsed YAML block in IntentSpec.core.md. This schema validates the parsed YAML (as JSON).",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "intent_id",
    "title",
    "goal",
    "scope",
    "acceptance",
    "tier",
    "doc_impact"
  ],
  "properties": {
    "intent_id": {
      "type": "string",
      "minLength": 1,
      "description": "Stable intent identifier (string)."
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "description": "Short human-readable title for the intent."
    },
    "goal": {
      "type": "string",
      "minLength": 1,
      "description": "Goal statement. Human guideline: 1â€“3 sentences; core gates do not enforce sentence counts."
    },
    "scope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["allowed_dirs", "forbidden_dirs"],
      "properties": {
        "allowed_dirs": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/RepoRelPathPrefix" },
          "description": "Repo-relative directory/prefixes that the change is allowed to touch."
        },
        "forbidden_dirs": {
          "type": "array",
          "items": { "$ref": "#/$defs/RepoRelPathPrefix" },
          "description": "Repo-relative directory/prefixes that the change must not touch. May be empty array."
        },
        "max_touched_files": {
          "type": "integer",
          "minimum": 0,
          "description": "Optional budget for number of touched files."
        },
        "max_loc_delta": {
          "type": "integer",
          "minimum": 0,
          "description": "Optional budget for LOC delta (insertions + deletions)."
        }
      }
    },
    "acceptance": {
      "type": "object",
      "additionalProperties": false,
      "required": ["success_criteria"],
      "properties": {
        "required_tests": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Optional list of required test commands/patterns. Core gates do not interpret these unless mapped by policy."
        },
        "success_criteria": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "List of success criteria statements (at least one)."
        }
      }
    },
    "tier": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tier_pack_id"],
      "properties": {
        "tier_pack_id": {
          "type": "string",
          "minLength": 1,
          "description": "Tier pack identifier (e.g., tier-0..tier-3)."
        }
      }
    },
    "doc_impact": {
      "type": "object",
      "additionalProperties": false,
      "required": ["required_paths"],
      "properties": {
        "required_paths": {
          "type": "array",
          "items": { "$ref": "#/$defs/RepoRelPath" },
          "description": "Repo-relative doc paths that MUST be updated by the validated change set. May be empty [] to explicitly indicate no doc updates required."
        },
        "note_on_empty": {
          "type": "string",
          "minLength": 1,
          "description": "Justification for doc impact decisions. REQUIRED when required_paths is empty []."
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "required_paths": { "maxItems": 0 }
            },
            "required": ["required_paths"]
          },
          "then": {
            "required": ["note_on_empty"],
            "properties": {
              "note_on_empty": {
                "type": "string",
                "minLength": 1,
                "pattern": ".*\\S.*"
              }
            }
          }
        }
      ]
    },
    "publication_intent": {
      "type": "object",
      "additionalProperties": false,
      "required": ["publish", "profile"],
      "properties": {
        "publish": {
          "type": "boolean",
          "description": "Explicit signal that this run intends to produce publishable (public-safe) artifacts."
        },
        "profile": {
          "type": "string",
          "enum": ["public", "internal"],
          "description": "Docs compiler profile selection (C3). NOTE: profile selection enforcement is policy/gate-defined."
        }
      },
      "description": "Publication intent and docs compiler profile declaration (explicit; no project_extension escape hatch)."
    },
    "waivers_requested": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": true
      },
      "description": "Optional list of waiver requests. Core gates do not interpret this unless mapped by policy. May be empty array."
    },
    "project_extension": {
      "type": "object",
      "additionalProperties": true,
      "description": "Project-specific extension object; not interpreted by core gates unless explicitly mapped."
    }
  },
  "$defs": {
    "RepoRelPath": {
      "type": "string",
      "minLength": 1,
      "pattern": "^(?!/)(?!\\./)(?!\\.\\.?(/|$))(?!.*(^|/)\\.\\.(/|$))(?!.*\\*)(?!.*\\?)(?!.*\\\\)(?!.*//)(?!.*\\/\\.\\/).+$",
      "description": "Repo-relative path using '/' separators. MUST NOT contain wildcards ('*', '?'), backslashes, '//' segments, '/./' segments, or '..' segments."
    },
    "RepoRelPathPrefix": {
      "type": "string",
      "minLength": 1,
      "pattern": "^(?!/)(?!\\./)(?!\\.\\.?(/|$))(?!.*(^|/)\\.\\.(/|$))(?!.*\\*)(?!.*\\?)(?!.*\\\\)(?!.*//)(?!.*\\/\\.\\/).+$",
      "description": "Repo-relative directory/prefix using '/' separators. MUST NOT contain wildcards ('*', '?'), backslashes, '//' segments, '/./' segments, or '..' segments."
    }
  }
  ,
  "allOf": [
    {
      "if": {
        "properties": {
          "tier": {
            "properties": {
              "tier_pack_id": { "enum": ["tier-2", "tier-3"] }
            },
            "required": ["tier_pack_id"]
          }
        },
        "required": ["tier"]
      },
      "then": {
        "required": ["publication_intent"]
      }
    }
  ]
}
